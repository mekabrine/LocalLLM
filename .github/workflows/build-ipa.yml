name: iOS Build

on:
  push:
    branches: ["**"]
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode (prefer 16.4 if available)
        shell: bash
        run: |
          set -euo pipefail
          if [ -d "/Applications/Xcode_16.4.app" ]; then
            echo "Using Xcode_16.4.app"
            sudo xcode-select -s "/Applications/Xcode_16.4.app/Contents/Developer"
          else
            echo "Xcode_16.4.app not found. Using current default:"
            xcode-select -p
          fi
          xcodebuild -version

      - name: Install XcodeGen
        shell: bash
        run: |
          set -euo pipefail
          brew update
          brew install xcodegen

      - name: Generate Xcode project
        shell: bash
        run: |
          set -euo pipefail
          # If you have project.yml at repo root, this will generate LocalGGUFChat.xcodeproj there.
          xcodegen generate
          ls -la

      - name: Verify project exists
        shell: bash
        run: |
          set -euo pipefail
          test -d "LocalGGUFChat.xcodeproj"
          echo "Found LocalGGUFChat.xcodeproj"

      - name: Resolve packages
        shell: bash
        run: |
          set -euo pipefail
          xcodebuild \
            -project "LocalGGUFChat.xcodeproj" \
            -scheme "LocalGGUFChat" \
            -destination "generic/platform=iOS Simulator" \
            -derivedDataPath "DerivedData" \
            IPHONEOS_DEPLOYMENT_TARGET=18.0 \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            -resolvePackageDependencies

      - name: Build (iOS Simulator)
        shell: bash
        run: |
          set -euo pipefail
          xcodebuild \
            -project "LocalGGUFChat.xcodeproj" \
            -scheme "LocalGGUFChat" \
            -configuration Release \
            -destination "generic/platform=iOS Simulator" \
            -derivedDataPath "DerivedData" \
            IPHONEOS_DEPLOYMENT_TARGET=18.0 \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            build
