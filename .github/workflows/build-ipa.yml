name: Build unsigned IPA

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select latest installed Xcode
        shell: bash
        run: |
          set -euo pipefail
          ls -1 /Applications | grep -E '^Xcode_.*\.app$|^Xcode\.app$' || true
          XCODE_APP="$(ls -d /Applications/Xcode*.app /Applications/Xcode_*.app 2>/dev/null | sort -V | tail -1)"
          echo "Using: $XCODE_APP"
          echo "DEVELOPER_DIR=$XCODE_APP/Contents/Developer" >> "$GITHUB_ENV"
          "$XCODE_APP/Contents/Developer/usr/bin/xcodebuild" -version

      - name: Install XcodeGen (to regenerate .xcodeproj)
        run: brew install xcodegen

      - name: Generate Xcode project
        run: xcodegen generate

      - name: Resolve Swift Packages
        run: |
          set -euo pipefail
          xcodebuild -resolvePackageDependencies -project LocalGGUFChat.xcodeproj

      - name: Build (iphoneos) with code signing disabled
        run: |
          set -euo pipefail
          xcodebuild \
            -project LocalGGUFChat.xcodeproj \
            -scheme LocalGGUFChat \
            -configuration Release \
            -destination "generic/platform=iOS" \
            -derivedDataPath DerivedData \
            IPHONEOS_DEPLOYMENT_TARGET=18.0 \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            build

      - name: Package unsigned IPA
        run: |
          set -euo pipefail
          APP_PATH="DerivedData/Build/Products/Release-iphoneos/LocalGGUFChat.app"
          test -d "$APP_PATH"
          rm -rf Payload LocalGGUFChat-unsigned.ipa
          mkdir -p Payload
          cp -R "$APP_PATH" Payload/
          /usr/bin/zip -r LocalGGUFChat-unsigned.ipa Payload

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: LocalGGUFChat-unsigned-ipa
          path: LocalGGUFChat-unsigned.ipa
