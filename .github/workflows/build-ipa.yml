name: iOS Build

on:
  push:
  pull_request:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode (prefer 16.4 if available)
        shell: bash
        run: |
          set -euo pipefail

          if [ -d "/Applications/Xcode_16.4.app/Contents/Developer" ]; then
            sudo xcode-select -s "/Applications/Xcode_16.4.app/Contents/Developer"
          elif ls /Applications/Xcode*.app >/dev/null 2>&1; then
            XCODE_APP="$(ls -1d /Applications/Xcode*.app | head -n 1)"
            sudo xcode-select -s "${XCODE_APP}/Contents/Developer"
          else
            echo "No Xcode found in /Applications"
            exit 1
          fi

          xcodebuild -version
          xcode-select -p

      - name: Install XcodeGen
        shell: bash
        run: |
          set -euo pipefail
          brew update
          brew install xcodegen

      - name: Generate Xcode project
        shell: bash
        run: |
          set -euo pipefail

          # Always generate so CI is deterministic
          rm -rf LocalGGUFChat.xcodeproj
          xcodegen generate --spec Project.yml

          test -d LocalGGUFChat.xcodeproj

      - name: Resolve packages
        shell: bash
        run: |
          set -euo pipefail
          xcodebuild -resolvePackageDependencies -project LocalGGUFChat.xcodeproj

      - name: Build (iOS Simulator)
        shell: bash
        run: |
          set -euo pipefail

          xcodebuild \
            -project LocalGGUFChat.xcodeproj \
            -scheme LocalGGUFChat \
            -configuration Release \
            -destination "generic/platform=iOS Simulator" \
            -derivedDataPath DerivedData \
            IPHONEOS_DEPLOYMENT_TARGET=18.0 \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            build

      - name: Zip .app (Simulator)
        shell: bash
        run: |
          set -euo pipefail
          APP_PATH="DerivedData/Build/Products/Release-iphonesimulator/LocalGGUFChat.app"
          test -d "$APP_PATH"
          ditto -c -k --sequesterRsrc --keepParent "$APP_PATH" "LocalGGUFChat-Simulator.app.zip"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: LocalGGUFChat-Simulator
          path: LocalGGUFChat-Simulator.app.zip
