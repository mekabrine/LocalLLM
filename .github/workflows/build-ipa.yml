# .github/workflows/build-unsigned.yml
name: Build (Unsigned, auto-generate Xcode project)

on:
  push:
    branches: [ "main" ]
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode 16.4
        run: |
          sudo xcode-select -s /Applications/Xcode_16.4.app
          xcodebuild -version

      - name: Install XcodeGen
        run: brew install xcodegen

      # OPTIONAL: force a consistent deployment target in CI without you editing anything locally.
      # (Your dependency currently requires iOS 18 in CI.)
      - name: Patch Project.yml deployment target (CI only)
        run: |
          set -euo pipefail
          if [ -f "project.yml" ]; then
            # Replace common "15.0" occurrences for deployment target with "18.0"
            # Safe if you later change it back in repo; this only affects CI workspace.
            /usr/bin/perl -0777 -i -pe 's/(deploymentTarget:\s*")15\.0(")/${1}18.0${2}/g; s/(IPHONEOS_DEPLOYMENT_TARGET\s*:\s*)15\.0/\${1}18.0/g' project.yml || true
          fi

      - name: Generate Xcode project (overwrite)
        run: |
          set -euo pipefail
          # Ensure we don't accidentally use a stale committed .xcodeproj
          rm -rf LocalGGUFChat.xcodeproj LocalGGUFChat.xcworkspace
          xcodegen generate

      - name: Resolve Swift packages
        run: |
          set -euo pipefail
          xcodebuild -resolvePackageDependencies -project LocalGGUFChat.xcodeproj

      - name: Build (Simulator, Release)
        run: |
          set -euo pipefail
          xcodebuild \
            -project LocalGGUFChat.xcodeproj \
            -scheme LocalGGUFChat \
            -configuration Release \
            -destination "generic/platform=iOS Simulator" \
            -derivedDataPath DerivedData \
            IPHONEOS_DEPLOYMENT_TARGET=18.0 \
            build

          APP_PATH="DerivedData/Build/Products/Release-iphonesimulator/LocalGGUFChat.app"
          ditto -c -k --sequesterRsrc --keepParent "$APP_PATH" "LocalGGUFChat-Simulator.app.zip"

      - name: Archive (Device, unsigned) + make IPA
        run: |
          set -euo pipefail
          rm -rf build Payload LocalGGUFChat-unsigned.ipa
          mkdir -p build

          xcodebuild \
            -project LocalGGUFChat.xcodeproj \
            -scheme LocalGGUFChat \
            -configuration Release \
            -destination "generic/platform=iOS" \
            -archivePath "build/LocalGGUFChat.xcarchive" \
            IPHONEOS_DEPLOYMENT_TARGET=18.0 \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            archive

          mkdir -p Payload
          cp -R "build/LocalGGUFChat.xcarchive/Products/Applications/LocalGGUFChat.app" Payload/
          /usr/bin/zip -r "LocalGGUFChat-unsigned.ipa" Payload

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: LocalGGUFChat-builds
          path: |
            LocalGGUFChat-Simulator.app.zip
            LocalGGUFChat-unsigned.ipa
            build/LocalGGUFChat.xcarchive
