# .github/workflows/build-unsigned.yml
name: Build (Unsigned, auto-generate Xcode project)

on:
  push:
    branches: [ "main" ]
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select an installed Xcode
        run: |
          set -euo pipefail
          echo "Installed Xcodes:"
          ls -1 /Applications | grep -E '^Xcode.*\.app$' || true

          if [ -d "/Applications/Xcode.app" ]; then
            sudo xcode-select -s "/Applications/Xcode.app"
          else
            XCODE_APP="$(ls -d /Applications/Xcode*.app | head -n 1)"
            sudo xcode-select -s "$XCODE_APP"
          fi

          xcode-select -p
          xcodebuild -version

      - name: Install XcodeGen
        run: brew install xcodegen

      # CI-only patch (only if your repo uses XcodeGen and you want CI to force a target)
      - name: Patch Project.yml deployment target (CI only)
        run: |
          set -euo pipefail
          if [ -f "project.yml" ]; then
            /usr/bin/perl -0777 -i -pe 's/(deploymentTarget:\s*")15\.0(")/${1}18.0${2}/g; s/(IPHONEOS_DEPLOYMENT_TARGET\s*:\s*)15\.0/\${1}18.0/g' project.yml || true
          fi

      - name: Generate Xcode project (overwrite)
        run: |
          set -euo pipefail
          rm -rf LocalGGUFChat.xcodeproj LocalGGUFChat.xcworkspace
          xcodegen generate

      - name: Resolve Swift packages
        run: |
          set -euo pipefail
          xcodebuild -resolvePackageDependencies -project LocalGGUFChat.xcodeproj

      - name: Build (Simulator, Release)
        run: |
          set -euo pipefail
          xcodebuild \
            -project LocalGGUFChat.xcodeproj \
            -scheme LocalGGUFChat \
            -configuration Release \
            -destination "generic/platform=iOS Simulator" \
            -derivedDataPath DerivedData \
            IPHONEOS_DEPLOYMENT_TARGET=18.0 \
            build

          APP_PATH="DerivedData/Build/Products/Release-iphonesimulator/LocalGGUFChat.app"
          ditto -c -k --sequesterRsrc --keepParent "$APP_PATH" "LocalGGUFChat-Simulator.app.zip"

      - name: Archive (Device, unsigned) + make IPA shell
        run: |
          set -euo pipefail
          rm -rf build Payload LocalGGUFChat-unsigned.ipa
          mkdir -p build

          xcodebuild \
            -project LocalGGUFChat.xcodeproj \
            -scheme LocalGGUFChat \
            -configuration Release \
            -destination "generic/platform=iOS" \
            -archivePath "build/LocalGGUFChat.xcarchive" \
            IPHONEOS_DEPLOYMENT_TARGET=18.0 \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            archive

          mkdir -p Payload
          cp -R "build/LocalGGUFChat.xcarchive/Products/Applications/LocalGGUFChat.app" Payload/
          /usr/bin/zip -r "LocalGGUFChat-unsigned.ipa" Payload

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: LocalGGUFChat-builds
          path: |
            LocalGGUFChat-Simulator.app.zip
            LocalGGUFChat-unsigned.ipa
            build/LocalGGUFChat.xcarchive
